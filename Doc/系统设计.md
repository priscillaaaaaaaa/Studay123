# 系统设计

## 1 概要设计和详细设计

### 1.1 系统结构

#### 1.1.1 功能说明

本项目是面向 1-3 年级儿童的口算练习微信小程序，聚焦 “轻量化练习 + 个性化管理” 核心需求，功能模块细化如下：

---

##### 1.1.1.1 用户系统
**身份认证**：基于微信授权快速登录，自动获取用户 OpenID 作为唯一标识，无需手动注册；支持用户拒绝授权时的降级处理（仅提供基础练习功能，限制错题集 / 收藏等个性化功能）。  

**信息管理**：支持用户完善个人资料（选择年级、修改昵称、更换头像），年级选择后自动关联对应难度题库；用户信息实时同步至云端，确保换设备登录时数据不丢失。  

**状态维护**：全局管理用户登录状态、当前练习进度（如中途退出后恢复练习）、历史练习记录统计（总答题数、累计正确率、总用时）。

---

##### 1.1.1.2 学习练习模块
**题库分级**：按年级划分基础题库（一年级：20 以内加减；二年级：100 以内加减、表内乘法；三年级：多位数加减、两位数乘一位数、简单除法），支持按题型（加法、减法、乘法、除法、混合运算）二次筛选。  

**练习模式**：提供 “每日一练”（固定 10 道题，每日更新）、“自定义练习”（用户可选择题目数量：10/20/30 道，自由切换题型）、“闯关练习”（分阶段设置难度梯度，每关 5 道题，正确率达 80% 可解锁下一关）三种模式。  

**答题交互**：题目按顺序逐一展示，支持手动输入答案或点击数字键盘输入；答题后实时反馈对错；练习结束生成详细报告（总用时、正确率、错题列表、知识点薄弱项分析）。

---

##### 1.1.1.3 错题与收藏管理
**错题集**：自动记录每道错题的题目内容、用户错误答案、正确答案、答题时间、所属知识点；支持按年级、题型筛选错题，并提供 “错题重做” 功能；支持错题导出为图片，分享给家长。  

**收藏夹**：用户可在练习过程中或错题集中手动收藏题目；支持按年级、题型筛选收藏题目及批量取消收藏；收藏数据与用户账号绑定，云端同步。

---

##### 1.1.1.4 数据存储与同步
**云端存储**：通过微信云数据库存储核心数据（题库、用户信息、练习记录、排行榜），并通过云存储存储用户头像与导出图片等文件；定期备份，防止数据丢失。  

**本地缓存**：使用微信小程序本地存储 API 缓存常用数据（题库、错题集、收藏夹），减少云端请求、提升速度；登录与页面切换时自动同步云端，确保一致性。

---

##### 1.1.1.5 页面导航与交互
**底部 TabBar 导航**：包含 “首页”“练习”“错题集”“我的” 四个核心页面，支持快速切换。  
首页展示每日一练入口、闯关进度、练习统计数据；“我的” 页面展示用户信息、收藏夹、排行榜、设置等。  

**页面跳转逻辑**：支持从练习页→结果页、结果页→错题详情页、首页→自定义练习页的跳转；跳转时添加动画并保留状态，支持中途恢复练习。

---

##### 1.1.1.6 辅助功能
**排行榜**：按年级展示用户答题正确率与总答题数排名（Top50），实时更新，支持查看自身排名。  

**消息提示**：完成练习后推送鼓励语；闯关成功时提示通关消息；可手动关闭推送。  

**意见反馈**：用户可提交文字及图片反馈，信息实时上传云端供开发者分析。

---

#### 1.1.2 接口设计

项目接口如下表 1-1 ～ 1-4 所示。



**表 1-1 云函数接口**

| 接口名称 | 功能描述 | 请求参数 | 返回结果 |
|-----------|------------|------------|------------|
| login | 获取用户 OpenID | 无 | `{openid:string}` |
| getLeaderboard | 获取排行榜数据 | `{grade:string}` | 排名列表 `[{user:string, score:number}]` |
| submitPracticeRecord | 提交练习记录 | `{grade:string, totalNum:number, correctNum:number, usedTime:number, wrongQuestionIds:Array<string>}` | `{success:boolean, msg:string}` |
| getPracticeHistory | 获取历史练习记录 | `{page:number, pageSize:number}` | `{historyList:Array, total:number}` |
| feedback | 提交意见反馈 | `{content:string, imageUrls:Array}` | `{success:boolean, msg:string}` |



**表 1-2 云数据库接口**

| 集合名称 | 操作类型 | 功能描述 | 示例查询条件 |
|-----------|------------|------------|------------|
| questions | 查询（get） | 获取对应年级题库 | `{grade:"一"}` |
| userInfo | 更新（update） | 同步用户信息 | `{openid:"xxx"}` |
| practiceRecords | 新增（add） | 存储用户练习记录 | `{openid, grade, totalNum, correctNum, usedTime, wrongQuestionIds}` |
| favorites | 增删改查 | 管理收藏题目 | `{openid:string}` |



**表 1-3 本地存储接口**

| 接口方法 | 功能描述 | 存储键名示例 |
|-----------|------------|------------|
| wx.setStorageSync | 保存错题 / 收藏题目 | wrongQuestions |
| wx.getStorageSync | 读取错题 / 收藏题目 | favorites |
| wx.removeStorageSync | 移除收藏题目 | favorites |
| wx.setStorageSync | 保存用户偏好设置 | userSettings |
| wx.getStorageSync | 读取本地缓存数据 | 对应存储键名 |

---

**表 1-4 页面跳转接口**

| 接口方法 | 应用场景 | 示例参数 |
|-----------|------------|------------|
| wx.navigateTo | 练习页 → 结果页 | `{url:"/packageM/pages/results/results"}` |
| wx.switchTab | 切换底部 TabBar 页面 | `{url:"/pages/home4/home4"}` |
| wx.redirectTo | 登录页 → 首页 | `{url:"/pages/home/home"}` |
| wx.reLaunch | 清除缓存后重新加载 | `{url:"/pages/home/home"}` |

---

### 1.2 类图等

本项目类图如下图 1-1 所示：

![class-diagram](./images/class-diagram.png "图1-1 类图")

---

### 1.3 数据结构与算法设计

#### 1.3.1 关键数据结构定义

##### （1）题库数据结构（Question）
```json
{
  "_id": "cloud-question-123",
  "grade": "一", 
  "type": "addition",
  "difficulty": "easy",
  "question": "15+7",
  "answer": "22",
  "knowledgePoint": "20以内进位加法",
  "createTime": "2024-01-10 10:00:00",
  "updateTime": "2024-01-10 10:00:00",
  "isEnabled": true
}
```



##### （2）用户核心数据：用户信息（UserInfo）
```json
{
  "_id": "cloud-user-456",
  "_openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M",
  "userInfo": {
    "nickName": "小明",
    "avatarUrl": "https://thirdwx.qlogo.cn/xxx",
    "gender": 1
  },
  "grade": "一",
  "settings": {
    "pushMsg": true,
    "defaultQuestionNum": 10,
    "inputMode": "keyboard",
    "theme": "light",
    "fontSize": "middle"
  },
  "practiceStats": {
    "totalQuestions": 0,
    "correctQuestions": 0,
    "totalAccuracy": 0,
    "totalUsedTime": 0,
    "averageUsedTime": 0,
    "gradeStats": {
      "一": { "total": 0, "correct": 0, "accuracy": 0 },
      "二": { "total": 0, "correct": 0, "accuracy": 0 },
      "三": { "total": 0, "correct": 0, "accuracy": 0 }
    },
    "typeStats": {
      "addition": { "total": 0, "correct": 0, "accuracy": 0 },
      "subtraction": { "total": 0, "correct": 0, "accuracy": 0 },
      "multiplication": { "total": 0, "correct": 0, "accuracy": 0 },
      "division": { "total": 0, "correct": 0, "accuracy": 0 },
      "mixed": { "total": 0, "correct": 0, "accuracy": 0 }
    },
    "lastPracticeTime": ""
  },
  "createTime": "2024-05-15 09:30:00",
  "updateTime": "2024-05-20 19:35:22"
}
```


##### （3）练习相关数据：练习记录（PracticeRecord）
```json
{
  "_id": "cloud-record-789",
  "_openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M",
  "grade": "二",
  "practiceMode": "custom",
  "type": "multiplication",
  "totalNum": 20,
  "correctNum": 17,
  "wrongNum": 3,
  "usedTime": 450,
  "averageTime": 22.5,
  "accuracy": 85.0,
  "wrongQuestionIds": ["cloud-question-1", "cloud-question-2", "cloud-question-3"],
  "knowledgePoints": ["表内乘法", "两位数乘一位数"],
  "createTime": "2024-05-20 19:35:22",
  "isSynced": true
}
```



##### （4）个性化数据：错题集（WrongQuestion）
```json
{
  "_id": "cloud-wrong-321",
  "_openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M",
  "questionId": "cloud-question-1",
  "question": {
    "grade": "二",
    "type": "multiplication",
    "difficulty": "medium",
    "question": "14×3",
    "answer": "42",
    "knowledgePoint": "两位数乘一位数"
  },
  "wrongAnswer": "41",
  "wrongTime": "2024-05-20 19:30:15",
  "redoStatus": "undone",
  "redoTime": ""
}
```



##### （5）个性化数据：收藏夹（Favorite）
```json
{
  "_id": "cloud-fav-654",
  "_openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M",
  "questionId": "cloud-question-5",
  "question": {
    "grade": "三",
    "type": "division",
    "difficulty": "hard",
    "question": "48÷3",
    "answer": "16",
    "knowledgePoint": "两位数除以一位数"
  },
  "collectTime": "2024-05-18 16:20:30",
  "isDeleted": false
}
```



##### （6）闯关模式数据：闯关记录（PassLevelData）
```json
{
  "_id": "cloud-pass-987",
  "_openid": "o6_bmjrPTlm6_2sgVt7hMZOPfL2M",
  "grade": "一",
  "currentLevel": 5,
  "passedLevels": [1, 2, 3, 4],
  "maxLevel": 10,
  "levelRecords": [
    {
      "level": 1,
      "accuracy": 100,
      "usedTime": 60,
      "passTime": "2024-05-15 16:20:10",
      "star": 3
    }
  ],
  "updateTime": "2024-05-19 14:30:25"
}
```

---

#### 1.3.2 关键算法设计

##### （1）题库随机筛选算法（完整版）
```javascript
/**
 * 生成练习题目列表
 * @param {string} grade - 年级（一/二/三）
 * @param {string} type - 题型（addition/subtraction等）
 * @param {number} count - 题目数量（10/20/30）
 * @param {boolean} avoidProficient - 是否排除熟练题型（正确率≥90%）
 * @returns {Promise} 题目列表
 */
async function generatePracticeQuestions(grade, type, count, avoidProficient = true) {
  try {
    // 1. 优先从本地缓存加载题库
    let localQuestions = wx.getStorageSync(`questionBank_${grade}_${type}`) || [];
    if (localQuestions.length === 0) {
      const cloudRes = await db.collection("questions")
        .where({ grade, type, isEnabled: true })
        .get();
      localQuestions = cloudRes.data || [];
      wx.setStorageSync(`questionBank_${grade}_${type}`, localQuestions);
      wx.setStorageSync(`questionBankExpire_${grade}_${type}`, Date.now() + 7 * 24 * 60 * 60 * 1000);
    }

    // 2. 检查缓存是否过期
    const expireTime = wx.getStorageSync(`questionBankExpire_${grade}_${type}`) || 0;
    if (Date.now() > expireTime) {
      const cloudRes = await db.collection("questions")
        .where({ grade, type, isEnabled: true })
        .get();
      localQuestions = cloudRes.data || [];
      wx.setStorageSync(`questionBank_${grade}_${type}`, localQuestions);
      wx.setStorageSync(`questionBankExpire_${grade}_${type}`, Date.now() + 7 * 24 * 60 * 60 * 1000);
    }

    // 3. 按难度分类
    const easy = localQuestions.filter(q => q.difficulty === "easy");
    const medium = localQuestions.filter(q => q.difficulty === "medium");
    const hard = localQuestions.filter(q => q.difficulty === "hard");

    // 4. 难度分配
    let easyCount = Math.round(count * 0.6);
    let mediumCount = Math.round(count * 0.3);
    let hardCount = count - easyCount - mediumCount;

    const result = [
      ...easy.slice(0, easyCount),
      ...medium.slice(0, mediumCount),
      ...hard.slice(0, hardCount)
    ];

    return result.sort(() => Math.random() - 0.5);
  } catch (error) {
    console.error("生成题目列表失败：", error);
    return [];
  }
}
```



### （2）答案校验算法
```javascript
function checkAnswer(question, userAnswer) {
  return String(userAnswer).trim() === String(question.answer).trim();
}
```



##### （3）错题记录算法
```javascript
function recordWrongQuestion(question, userAnswer) {
  const wrongItem = {
    questionId: question._id,
    question: question.question,
    correctAnswer: question.answer,
    wrongAnswer: userAnswer,
    time: new Date().toLocaleString()
  };
  const wrongList = wx.getStorageSync('wrongQuestions') || [];
  wrongList.push(wrongItem);
  wx.setStorageSync('wrongQuestions', wrongList);
}
```

---

#### 1.3.3 数据管理说明

##### （1）数据存储策略
- **云端存储**：核心题库（`questions` 集合）、用户基础信息（`userInfo` 集合）、排行榜数据。  
- **本地缓存**：临时练习记录、错题集、收藏列表（`wx.setStorageSync` / `wx.getStorageSync`），减少云端请求。

##### （2）数据同步机制
- 用户首次登录时，通过云函数 `login` 获取 OpenID 并初始化云端数据。
- 题库优先从云端加载，失败则回退到本地备份数据。
- 错题集与收藏夹本地为主，支持手动同步到云端。

##### （3）数据安全
- 用户数据通过 OpenID 隔离。
- 云数据库配置权限：仅允许用户访问自己的记录。
- 排行榜提交通过云函数校验，防止数据篡改。

